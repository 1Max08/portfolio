<?php
if (!isset($_SESSION)) session_start();
if (!isset($_SESSION['user'])) {
    header("Location: index.php?page=login");
    exit;
}
?>

<div class="dashboard">
    <h2>Éditer le profil</h2>
    
    <form method="POST">
        <p>Introduction:</p>
        <input type="text" name="introduction" value="<?= htmlspecialchars($profil->introduction ?? '') ?>" />
    
        <p>Description:</p>
        <textarea name="description"><?= htmlspecialchars($profil->description ?? '') ?></textarea>
    
        <p>Photo de profil (URL):</p>
        <input type="text" name="profil_image" value="<?= htmlspecialchars($profil->profil_image ?? '') ?>" />
        
        <button type="submit" name="updateProfil">Changer</button>
    </form>

<h2>Compétences</h2>

<!-- Ajouter compétence -->
<form method="POST">
    <h3>Ajouter une compétence</h3>

    <p>Nom</p>
    <input type="text" name="competence_name" required>

    <p>Niveau</p>
    <input type="text" name="competence_level" required>

    <button type="submit" name="addCompetence">
        Ajouter
    </button>
</form>

<?php if (!empty($competences)): ?>
    <ul>
        <?php foreach ($competences as $comp): ?>
            <li>
                <?= htmlspecialchars($comp->name) ?>
                (<?= htmlspecialchars($comp->level) ?>)

                <a href="index.php?page=changeCompetence&id=<?= $comp->id ?>">
                    <button type="button">Changer</button>
                </a>

                <a href="index.php?page=board&deleteCompetence=<?= $comp->id ?>" onclick="return confirm('Supprimer cette compétence ?');">
                    <button type="button">Supprimer</button>
                </a>
            </li>
        <?php endforeach; ?>
    </ul>
<?php else: ?>
    <p>Aucune compétence enregistrée.</p>
<?php endif; ?>

<?php if (isset($competenceToEdit) && $competenceToEdit): ?>
    <h3>Modifier la compétence</h3>

    <form method="POST">
        <input type="hidden" name="competence_id"
               value="<?= $competenceToEdit->id ?>">

        <p>Nom</p>
        <input type="text" name="competence_name"
               value="<?= htmlspecialchars($competenceToEdit->name) ?>" required>

        <p>Niveau</p>
        <input type="text" name="competence_level"
               value="<?= htmlspecialchars($competenceToEdit->level) ?>" required>

        <button type="submit" name="updateCompetence">
            Mettre à jour
        </button>
    </form>
<?php endif; ?>
        
        <?php foreach ($projects as $project): ?>
            <h2 class="title"><?= htmlspecialchars($project->title) ?></h2>
            <div class="dashboard-buttons">
                <a href="index.php?page=change&id=<?= $project->id ?>">
                    <button type="button">Changer</button>
                </a>
                <a href="index.php?page=board&deleteProject=<?= $project->id ?>" onclick="return confirm('Voulez-vous vraiment supprimer ce projet ?');">
                    <button type="button">Supprimer</button>
                </a>
            </div>
        <?php endforeach; ?>


    <div class="dashboard-buttons">
        <a href="index.php?page=create">
            <button type="button">Créer</button>
        </a>
        <a href="index.php?page=about">
            <button type="button">Retourner</button>
        </a>
    </div>
    
    <h2>Experiences</h2>
        <?php if (!empty($experiences)): ?>
        <?php foreach ($experiences as $exp): ?>
            <div class="experience">
                <h3><?= htmlspecialchars($exp->title) ?></h3>
                <p><?= htmlspecialchars($exp->short_description) ?></p>
                <div class="dashboard-buttons">
                    <a href="index.php?page=changeExperience&id=<?= $exp->id ?>">
                        <button type="button">Changer</button>
                    </a>
                    <a href="index.php?page=board&deleteExperience=<?= $exp->id ?>" onclick="return confirm('Supprimer cette expérience ?');">
                        <button type="button">Supprimer</button>
                    </a>
                </div>
            </div>
        <?php endforeach; ?>
    <?php else: ?>
        <p>Aucune expérience enregistrée.</p>
    <?php endif; ?>
        <div class="dashboard-buttons">
        <a href="index.php?page=createExperience"><button type="button">Créer une expérience</button></a>
    </div>


    <h2>Messages reçus</h2>

    <?php if (empty($messages)): ?>
        <p>Aucun message pour le moment.</p>
    <?php else: ?>
        <?php foreach ($messages as $message): ?>
            <div class="message <?= $message->isRead ? 'read' : 'unread' ?>">
                <p><strong>Nom :</strong> <?= htmlspecialchars($message->name) ?></p>
                <p><strong>Email :</strong> <?= htmlspecialchars($message->email) ?></p>
                <?php if (!empty($message->subject)): ?>
                    <p><strong>Sujet :</strong> <?= htmlspecialchars($message->subject) ?></p>
                <?php endif; ?>
                <p><?= nl2br(htmlspecialchars($message->message)) ?></p>
                <small><?= htmlspecialchars($message->createdAt) ?></small>

                <div class="dashboard-buttons">
                    <?php if (!$message->isRead): ?>
                        <a href="index.php?page=board&readMessage=<?= $message->id ?>">
                            <button type="button">Marquer comme lu</button>
                        </a>
                    <?php endif; ?>
                    <a href="index.php?page=board&deleteMessage=<?= $message->id ?>" onclick="return confirm('Supprimer ce message ?');">
                        <button type="button">Supprimer</button>
                    </a>
                </div>
            </div>
        <?php endforeach; ?>
    <?php endif; ?>
    <div class="dashboard-buttons">
            <a href="index.php?page=logout">
            <button type="button">Déconnexion</button>
        </a>
    </div>
</div>